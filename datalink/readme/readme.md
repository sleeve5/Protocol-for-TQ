# Proximity-1 空间链路协议仿真系统说明文档

**—— 数据链路层 (Data Link Layer)**

## 1. 系统概述 (System Overview)

本项目基于 MATLAB 平台，设计并实现了一个符合 **GB/T 39353-2020**（修改采用 ISO 21459:2015 / CCSDS 211.2-B-3）标准的 Proximity-1 协议数据链路层仿真系统。

系统构建了一个完整的深空通信协议栈闭环，涵盖了从**数据链路层 (Data Link Layer)** 的帧生成与 ARQ 重传，到 **编码与同步子层 (C&S Sublayer)** 的信道编码，再到 **物理层 (Physical Layer)** 的调制与传输。

核心特性包括：

1. **高增益信道编码**：实现 CCSDS C2 码族 LDPC (Rate 1/2)，在低信噪比下提供强力纠错。
2. **双重同步机制**：物理层 CSM 同步与链路层 ASM 同步相结合，解决深空盲同步难题。
3. **可靠传输协议**：实现了 COP-P (Communication Operations Procedure) 中的 FOP-P 和 FARM-P 状态机，支持 Go-Back-N 自动重传 (ARQ)。
4. **流式处理架构**：接收端采用双缓冲分层状态机，能够处理碎片化、非对齐的实时比特流。

---

## 2. 工程目录结构

```text
Data-Link-Layer/
├── data/                       # 数据缓存目录
│   └── CCSDS_C2_matrix.mat     # 预生成的 LDPC H 矩阵
├── libs/                       # 核心算法库
│   ├── scs_transmitter.m       # [C&S] 发送主控函数 (PLTU封装 + LDPC编码)
│   ├── receiver.m              # [C&S] 接收主控函数 (批处理模式)
│   ├── Proximity1Receiver.m    # [C&S] 接收机类 (流式状态机模式)
│   ├── ldpc_encoding_chain.m   # [C&S] LDPC 编码链路
│   ├── ldpc_decoder.m          # [C&S] LDPC 译码链路
│   ├── frame_synchronizer.m    # [C&S] 通用同步器 (CSM/ASM)
│   ├── build_PLTU.m            # [C&S] PLTU 组装
│   ├── frame_generator.m       # [DLL] 传送帧生成器 (Header + Payload)
│   ├── frame_parser.m          # [DLL] 传送帧解析器
│   ├── FOP_Process.m           # [DLL] 发送端 FOP-P 状态机 (ARQ 控制)
│   ├── FARM_Process.m          # [DLL] 接收端 FARM-P 状态机 (ARQ 控制)
│   ├── build_PLCW.m            # [DLL] 控制字 PLCW 生成
│   ├── parse_PLCW.m            # [DLL] 控制字 PLCW 解析
│   ├── CRC32.m                 # 工具: CRC 生成
│   ├── CRC32_check.m           # 工具: CRC 校验
│   ├── generate_idle_sequence.m # 工具: 空闲序列
│   └── hex2bit_MSB.m           # 工具: 进制转换
├── utils/                      # 工具脚本
│   └── generate_ccsds_c2_matrix.m # CCSDS C2 H 矩阵生成算法实现
├── readme/
│   ├── CRC32.md                # CRC32算法
│   ├── LDPC.md                 # LDPC 编码算法
│   ├── transmitter.md          # 发射机逻辑
│   ├── receivers.md            # 两种接收机逻辑
│   ├── framing.md              # 帧结构设计
│   ├── COP_P.md                # 通信操作过程
│   └── readme.md               # 本项目介绍
├── test_main.m                 # [入口] 全协议栈流式闭环仿真
├── test_unit_fsm.m             # [入口] 基于状态机的流式接收测试
├── test_unit_farm.m            # [入口] 接收端逻辑单元测试
└── test_session.m              # [入口] 会话建立测试脚本
```

---

## 3. 协议参数配置

本项目中使用的关键技术参数严格对应标准文档：

| 参数项         | 取值 / 描述                                      | 标准依据                      |
|:----------- |:-------------------------------------------- |:------------------------- |
| **ASM**     | `0xFAF320` (24 bits)                         | GB/T 39353 §7.3           |
| **CRC 多项式** | `0x00A00805` (32 bits)                       | GB/T 39353 Annex C        |
| **LDPC 类型** | CCSDS C2 Family (QC-LDPC)                    | CCSDS 131.0-B-5 §7.4      |
| **码率 / 块长** | Rate 1/2, $k=1024, n=2048$                   | CCSDS 131.0-B-5 Table 7-5 |
| **CSM**     | `0x034776C7272895B0` (64 bits)               | CCSDS 131.0-B-5 §8.2.2    |
| **随机化多项式**  | $h(x) = x^8 + x^6 + x^4 + x^3 + x^2 + x + 1$ | CCSDS 131.0-B-5 §10.4     |
| **空闲序列**    | `0x352EF853` (PN Pattern)                    | GB/T 39353 §8.1           |

---

## 4. 数据流与帧封装原理 (Data Flow & Encapsulation)

在 C&S 子层中，数据经历了三次形态转换，形成了严格的层级封装结构。

### 4.1 封装流程图解

$$
\text{User Payload} \xrightarrow{\text{Framing}} \text{PLTU} \xrightarrow{\text{Streaming}} \text{Bitstream} \xrightarrow{\text{Channel Coding}} \text{Phy Symbols}
$$

### 4.2 详细流转步骤

#### **阶段一：PLTU 封装 (Framing)**

这一步将离散的传送帧（Transfer Frame）封装为邻近链路传输单元（PLTU）。

- **输入**：变长传送帧（Transfer Frame）。
- **处理**：
  1. **CRC 计算**：对传送帧计算 32 位校验码，附在帧尾。
  2. **ASM 插入**：在帧头插入 24 位 **附加密码同步标志 (ASM)**。
- **输出**：$L_{PLTU} = 24 (\text{ASM}) + L_{Frame} + 32 (\text{CRC})$ bits。
- **原理意义**：ASM 用于在接收端的数据流中定位帧的起始，CRC 用于验证帧内容的完整性。注意：**ASM 不参与 CRC 校验**，实现了物理层同步与链路层校验的解耦。

#### **阶段二：流控制 (Stream Control)**

这一步将离散的 PLTU 拼接为连续的比特流，适配物理层发射机。

- **处理**：
  1. **捕获序列 (Acquisition Seq)**：在传输开始前发送空闲序列（Idle Pattern），帮助接收机锁相环 (PLL) 和位同步器锁定。
  2. **空闲填充 (Idle Data)**：在 PLTU 之间插入空闲序列，维持链路连接。
  3. **尾序列 (Tail Seq)**：在传输结束时发送，确保最后的数据完全移出编码器缓冲区。
  4. **LDPC 块对齐 (Padding)**：计算总比特流长度，若不能被 1024 整除，则在末尾补足空闲序列。这是因为 LDPC 是定长块编码。

#### **阶段三：信道编码 (Channel Coding)**

这一步将逻辑比特流转化为具备纠错能力的物理层符号。

- **输入**：1024 bits 的信息块 (Information Block)。
- **处理**：LDPC 编码 $\to$ 打孔 $\to$ 随机化 $\to$ 插入 CSM。
- **输出**：2112 bits 的物理层码块 (Codeblock)。

---

## 5. 核心算法原理 (Theoretical Details)

### 5.1 CRC-32 检错算法

本项目实现了 Proximity-1 特有的 CRC-32 算法，用于检测残留误码。

- **生成多项式**：
  $$ G(x) = x^{32} + x^{23} + x^{21} + x^{11} + x^2 + 1 $$
  对应十六进制系数：`0x00A00805`。
- **数学原理**：
  设信息多项式为 $M(x)$，校验码 $R(x)$ 满足：
  $$ M(x) \cdot x^{32} = Q(x)G(x) + R(x) $$
  即 $R(x)$ 是 $M(x)$ 左移 32 位后除以 $G(x)$ 的余数（模2运算）。
- **配置差异**：
  与标准以太网 CRC-32 不同，Proximity-1 规定：
  1. **初始状态**：全 0 (`0x00000000`)。
  2. **结果处理**：不取反（Direct）。
  3. **位序**：MSB First（大端序）。

### 5.2 LDPC 信道编码

本项目实现了 **CCSDS C2 码族** (Rate 1/2, k=1024)，这是专为近地/邻近链路设计的准循环 (QC-LDPC) 码。

#### **(1) 校验矩阵 H 的构造**

校验矩阵 $H$ 定义了码字的线性约束关系 $C \cdot H^T = 0$。

- **子矩阵大小**：$M = 512$。
- **矩阵结构**：$H$ 是一个 $1536 \times 2560$ 的稀疏矩阵，由 $3 \times 5$ 个 $M \times M$ 的子块组成。
- **置换矩阵 $\Pi_k$**：
  C2 码不使用简单的循环移位，而是基于代数公式生成的置换矩阵。其第 $i$ 行非零元素的位置 $\pi_k(i)$ 由下式确定：
  $$ \pi_k(i) = \frac{M}{4} \left( (\theta_k + \lfloor \frac{4i}{M} \rfloor) \bmod 4 \right) + \left( (\phi_k(\lfloor \frac{4i}{M} \rfloor, M) + i) \bmod \frac{M}{4} \right) $$
  这种复杂的置换设计是为了消除短环（Girth），提升译码性能，消除错误平层。

#### **(2) 打孔 (Puncturing)**

- 编码器生成的原始码字长度为 $5 \times M = 2560$ bits。
- **操作**：丢弃最后 $M = 512$ bits。
- **结果**：传输长度变为 $2560 - 512 = 2048$ bits。
- **码率计算**：$R = k/n = 1024 / 2048 = 1/2$。

#### **(3) 伪随机化 (Pseudo-Randomization)**

为了防止发射全 0 或全 1 序列导致接收机位同步失锁，必须对码字进行加扰。

- **多项式**：$h(x) = x^8 + x^6 + x^4 + x^3 + x^2 + x + 1$。
- **操作**：将 LDPC 码字与该多项式生成的伪随机序列进行按位异或 (XOR)。

### 5.3 CSM 与 ASM 双重同步

系统采用了独特的双层同步机制：

1. **物理层同步 (CSM - 64 bits)**：
   - **值**：`0x034776C7272895B0`。
   - **作用**：插入在每个 LDPC 码块之前。接收机利用高自相关性在低信噪比下锁定 CSM，从而确定 LDPC 译码的起始边界。
2. **链路层同步 (ASM - 24 bits)**：
   - **值**：`0xFAF320`。
   - **作用**：插入在 PLTU 头部。LDPC 译码输出的是连续比特流，接收机在其中搜索 ASM 以确定数据帧的边界。

---

## 6. 工程实现说明 (Implementation)

### 6.1 发送主控 (`scs_transmitter.m`)

发送端采用流式处理架构：

1. **Buffer Management**：使用 Cell 数组缓存组装好的 PLTU 和空闲序列，最后一次性拼接，提高 MATLAB 内存效率。
2. **Alignment Logic**：内置智能填充算法，计算 `mod(total_bits, 1024)`，自动补齐尾部，防止 LDPC 编码器因维度不匹配报错。

### 6.2 接收主控 (`receiver.m` / `Proximity1Receiver.m`)

接收端实现了复杂的**盲接收**逻辑，支持批处理和流式状态机两种模式：

1. **CSM 搜索**：使用滑动相关器 (`conv`) 在软信息流中寻找峰值，锁定 LDPC 块。
2. **软判决译码**：直接处理 LLR (Log-Likelihood Ratio)，相比硬判决译码有约 2dB 的性能增益。
3. **滑动 CRC 校验 (Sliding CRC Search)**：
   - 由于接收机预先不知道帧长，且 LDPC 输出是定长流，导致 PLTU 边界未知。
   - **算法**：找到 ASM 后，向后遍历可能的帧结束位置，对截取的数据段尝试 CRC 校验。一旦校验通过 (`Magic Check`)，即认定成功提取一帧。

---

## 7. 如何运行 (How to Run)

本项目提供了分层次的测试脚本，分别用于验证全链路系统性能和核心模块的逻辑正确性。

### 7.1 环境准备

1. 确保 MATLAB 安装了 **Communications Toolbox**。
2. 无需手动添加路径，所有测试脚本开头已内置自动路径配置代码 (`addpath(genpath(...))`)。

### 7.2 仿真脚本说明

| 脚本文件名                  | 类型               | 功能描述                                                                                                                                                           | 预期结果                                                                       |
|:---------------------- |:---------------- |:-------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-------------------------------------------------------------------------- |
| **`test_session.m`**   | **[主入口]** 会话建立仿真 | **会话建立与握手。** 模拟 17万公里延迟下的 Hailing 过程。                                                                                                                          | 状态机从```INACTIVE```成功迁移至```DATA_SERVICES```。                                |
| **`test_main.m`**      | **[主入口]** 全系统仿真  | **全栈 ARQ 演示。** 模拟 Alice 与 Bob 之间的双向通信。包含： <br>1. 变长帧生成与封装；<br>2. LDPC 编码与调制；<br>3. **信道突发干扰模拟 (SNR 骤降)** ；<br>4. 接收端流式解调与同步；<br>5. **ARQ 自动重传演示 (Go-Back-N)**。 | 当模拟丢包发生时，触发 **NACK** 并自动执行 **Go-Back-N** 重传，最终数据无误。                        |
| **`test_unit_fsm.m`**  | 鲁棒性测试            | 专门测试 **`Proximity1Receiver`** 类的流式处理能力。模拟数据以极小碎片（1-256 bits）随机到达的情况。                                                                                           | 验证接收机内部状态机能否在数据碎片化的情况下正确拼接并还原数据帧。                                          |
| **`test_unit_farm.m`** | 逻辑验证             | 专门测试数据链路层的 **FARM-P (接收控制)** 逻辑。不涉及物理层，直接输入帧头信息。                                                                                                               | 验证接收端能否正确识别：<br>- 正常帧 (Accept)<br>- 乱序帧 (Reject + Retx)<br>- 重复帧 (Discard) |

### 7.3 运行步骤示例

**运行全链路闭环仿真：**

1. 在 MATLAB 中打开 `test_main.m`。
2. 点击 **Run**。
3. 观察 Command Window 输出的日志，重点关注 `[Simulation Step 2]` (模拟丢包) 和 `[Simulation Step 4]` (自动重传) 的过程。

**输出日志示例：**

```text
...
[Channel] 💥 突发强干扰! SNR 降至 0.5 dB
[Bob DLL] ❌ 未收到有效帧 (物理层丢包)
...
[FARM] 检测到丢帧! 期望 1, 收到 2. 请求重传.
[Feedback] Bob 发送 NACK: Expecting V(R)=1
[Alice] 状态: 重传模式.
...
✅ 测试结论: SUCCESS - 所有数据帧均完美恢复！
```

---

## 8. 仿真结论 (Simulation Conclusions)

通过运行全协议栈闭环测试脚本 (`test_main.m`)，本系统在模拟的深空通信信道环境下进行了全面验证。仿真结果表明系统达到了以下关键技术指标：

### 8.1 物理层抗噪性能 (PHY Robustness)

* **纠错能力**：在 $E_b/N_0 = 4.0 \text{dB}$ 的信噪比条件下，**CCSDS C2 LDPC (Rate 1/2)** 成功纠正了所有解调误码，实现了 **Post-FEC BER = 0**。
* **同步鲁棒性**：接收机的**双层状态机 (FSM)** 在信道突发强干扰（SNR 骤降至 0.5 dB，导致物理层失锁）的情况下，未发生程序崩溃或状态死锁，并在信道恢复后自动重新锁定了 CSM 和 ASM。

### 8.2 数据链路层可靠性 (DLL Reliability)

* **ARQ 机制验证**：成功演示了 **COP-P (Go-Back-N)** 协议的完整闭环。
  1. **丢包检测**：当物理层因强噪声导致丢帧时，FARM-P 准确识别了序号跳变（Gap Detected）。
  2. **重传请求**：接收端生成了正确的 **NACK (PLCW)** 控制帧。
  3. **自动恢复**：发送端 FOP-P 成功解析 NACK，回退发送指针，并重发了丢失帧及其后续帧。
* **最终一致性**：尽管传输过程中发生了丢包和重传，最终交付给用户的 Payload 数据 **无乱序、无丢失、无重复**。

### 8.3 工程架构验证 (Architecture Verification)

* **流式处理能力**：接收机成功处理了 **碎片化 (Fragmented)** 的输入数据流（模拟硬件 FIFO 行为），证明了“双缓冲分层状态机”架构在处理跨块传输和变长帧时的正确性。
* **自适应解帧**：**滑动 CRC 校验** 算法在未知帧长的情况下，实现了 100% 准确的变长帧提取，且有效过滤了 Payload 中伪造的 ASM 头部干扰。

**结论**：本项目成功构建了一个符合 CCSDS 标准、具备工业级流式处理能力且具有自我修复功能的深空通信协议栈原型。

---

## 9. 差距分析与后续展望 (Gap Analysis)

目前系统已经实现了 **GB/T 39353 (CCSDS Proximity-1)** 编码与同步子层中 **最先进、最复杂** 的部分（即 **LDPC C2 码 Rate 1/2** 模式）。若对照**完整的协议标准**，目前的实现为 **“特定模式下的全功能实现”**。

以下是详细的 **已实现功能** vs **未实现/待改进功能** 的差距分析报告。

### 9.1 已完全实现的功能

这部分代码已经达到了 **工程级（Engineering Grade）** 标准：

- ✅ **PLTU 封装**：CRC-32 生成、ASM 插入、变长帧处理。
- ✅ **流控制**：捕获序列、尾序列、空闲填充、LDPC 块对齐。
- ✅ **LDPC 编码 (Rate 1/2)**：基于 CCSDS 131.0 C2 标准的矩阵构造、打孔、随机化、CSM 插入。
- ✅ **接收同步**：基于数据辅助的物理层捕获、CSM 帧同步。
- ✅ **自适应接收**：基于 ASM 搜索 + 滑动 CRC 校验的变长帧提取。
- ❓ **接口适配**：与物理层（调制/解调/光电/PLL）的软信息交互接口。

### 9.2 标准中规定但尚未实现的功能

要完全实现 Proximity-1 C&S 子层，还需要补充以下内容：

#### **(1) 卷积编码 (Convolutional Code) —— 缺失**

- **标准依据**：GB/T 39353 第 9.3 节。
- **描述**：这是 Proximity-1 的**基础/默认编码方式**（通常用于低速率或算力受限的场景）。
- **技术细节**：Rate 1/2, Constraint Length 7, 采用 Viterbi 译码。
- **现状**：代码中 `CodingType=1` 留空。
- **影响**：不支持传统的深空通信模式。

#### **(2) 其他 LDPC 码率 (Rate 2/3, 4/5, 7/8) —— 缺失**

- **标准依据**：CCSDS 131.0-B-5 第 7.4 节。
- **描述**：C2 码族不仅有 Rate 1/2，还有 2/3 和 4/5（用于信道较好时提高吞吐量）。此外还有基于 RS 构造的 Rate 7/8 LDPC。
- **技术细节**：
  - 需要生成 $M=256$ (Rate 2/3) 或 $M=128$ (Rate 4/5) 的矩阵。
  - 打孔模式不同。
  - Rate 7/8 使用的是 32位 CSM (`1ACFFC1D`)，而不是 64位。
- **现状**：目前仅实现了 Rate 1/2 ($M=512$)。

#### **(3) 定时服务 (Timing Services) —— 缺失**

- **标准依据**：GB/T 39353 第 10.5.6 节 (Send Side) & 11.3.6.8 节 (Receive Side)。
- **描述**：Proximity-1 协议的一个核心功能是**时间标签 (Time Tagging)**，用于测量距离和时钟校准。
- **具体要求**：
  - **发送端**：必须记录 ASM 最后一比特离开天线的时刻。
  - **接收端**：必须记录 ASM 最后一比特到达的时刻。
- **现状**：物理层实现了测距（基于相关峰），但 C&S 子层尚未向上传递时间戳信息。

#### **(4) 质量指示器 (Quality Indicator) —— 隐式实现**

- **标准依据**：Annex B (Service)。
- **描述**：接收端在向上传递帧时，应附带一个标志位：`Good` 或 `Bad`。
- **现状**：目前代码逻辑是“只输出 Good 的帧，丢弃 Bad 的帧”。这在逻辑上正确，但在标准接口定义上，应该允许输出错误帧并标记为 Bad（供上层统计或诊断）。

### 9.3 工程实现的改进空间

为了进一步提升系统的**效率**和**真实性**，可考虑以下优化方向：

#### **(1) 性能优化：滑动 CRC 的实现**

- **当前做法**：在 `receiver` 中，找到 ASM 后，每隔 8 bit 就调用一次 `CRC32_check`。
  - **缺点**：`comm.CRCDetector` 每次通过 `step` 调用会有开销，且重复计算量大。
- **改进**：实现**增量式 CRC (Incremental CRC)** 或 **查表法**。利用前一次的 CRC 结果计算下 8 bit 的结果，而不是每次都从头算一遍。这将使解帧速度提高几十倍。

#### **(2) 量化效应 (Quantization)**

- **当前做法**：使用 `double` 类型的浮点数传递 LLR。
- **改进**：真实的星上硬件（FPGA/ASIC）使用的是**定点数**（例如 4-bit 或 8-bit 量化）。
  - 可以尝试将 `rx_soft_values` 量化为 `int8`，观察对 LDPC 译码性能的损失（通常损失 < 0.2 dB）。这将使仿真更接近硬件真实表现。

#### **(3) 异常处理**

- **当前做法**：如果 `frame_synchronizer` 找不到匹配，直接 `return`。
- **改进**：实现**同步保护策略**。
  - 例如：连续检测到 3 个 CSM 才进入锁定状态（Lock），连续丢失 5 个 CSM 才失锁（Unlock）。防止噪声导致的虚假同步或偶尔的同步丢失。
